import { Component, ContentChild, EventEmitter, Input, Output, ViewChild } from '@angular/core';
import { debounceTime, Subject } from 'rxjs';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common";
import * as i2 from "angular-resize-event";
import * as i3 from "../../../base-checkbox/components/checkbox/checkbox.component";
import * as i4 from "@angular/forms";
import * as i5 from "ngx-infinite-scroll";
import * as i6 from "../table-header-cell/table-header-cell.component";
import * as i7 from "../table-body-cell/table-body-cell.component";
export class TableComponent {
    constructor() {
        this.items = [];
        this.selectable = false;
        this.rowClickable = false;
        this.compactHeader = false;
        this.selected = new EventEmitter();
        this.rowClicked = new EventEmitter();
        this.scrolled = new EventEmitter();
        this.tableSizeChanged$ = new Subject();
        this.isHorizontalScrollDisplayed = false;
        this.selectedItems = {};
    }
    get areAllSelected() {
        return this.items.length && Object.values(this.selectedItems).filter((v) => v).length === this.items.length;
    }
    ngOnInit() {
        this.tableSizeChanged$.pipe(debounceTime(100)).subscribe((event) => {
            const tableWrapperWidth = this.tableWrapper.nativeElement.offsetWidth;
            const tableWidth = event.newRect.width;
            this.isHorizontalScrollDisplayed = tableWrapperWidth < tableWidth;
        });
        if (this.selectable) {
            this.items.forEach((i) => (this.selectedItems[i.id] = false));
        }
        if (this.clearSelected$) {
            this.clearSelected$.subscribe(() => {
                this.selectedItems = {};
                this.selected.emit([]);
            });
        }
    }
    checkTableSize(event) {
        this.tableSizeChanged$.next(event);
    }
    selectAllItems() {
        if (!this.areAllSelected) {
            const ids = this.items.map((i) => {
                this.selectedItems[i.id] = true;
                return i.id;
            });
            this.selected.emit(ids);
        }
        else {
            this.selectedItems = {};
            this.selected.emit([]);
        }
    }
    selectItem(selected, id) {
        this.selectedItems[id] = selected;
        const ids = Object.entries(this.selectedItems)
            .filter(([, value]) => value)
            .map(([key]) => key);
        this.selected.emit(ids);
    }
    click(item) {
        this.rowClicked.emit(item);
    }
}
TableComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: TableComponent, deps: [], target: i0.ɵɵFactoryTarget.Component });
TableComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "14.2.12", type: TableComponent, selector: "dfm-table", inputs: { items: "items", selectable: "selectable", clearSelected$: "clearSelected$", rowClickable: "rowClickable", compactHeader: "compactHeader" }, outputs: { selected: "selected", rowClicked: "rowClicked", scrolled: "scrolled" }, queries: [{ propertyName: "headerRowTemplate", first: true, predicate: ["headerRowTemplate"], descendants: true }, { propertyName: "bodyRowTemplate", first: true, predicate: ["bodyRowTemplate"], descendants: true }], viewQueries: [{ propertyName: "tableWrapper", first: true, predicate: ["tableWrapper"], descendants: true }], ngImport: i0, template: "<div class=\"dfm-table-wrapper\" #tableWrapper infiniteScroll (scrolled)=\"scrolled.emit()\" [scrollWindow]=\"false\">\n  <table\n    class=\"dfm-table w-100\"\n    [class.first-frozen]=\"isHorizontalScrollDisplayed\"\n    [class.compact-header]=\"compactHeader\"\n    (resized)=\"checkTableSize($event)\"\n  >\n    <thead class=\"header\">\n      <tr>\n        <dfm-table-header-cell *ngIf=\"selectable\" class=\"checkbox-cell\" [class.checkbox-first-frozen]=\"isHorizontalScrollDisplayed\">\n          <dfm-checkbox class=\"d-flex dfm-me-2\" [ngModel]=\"areAllSelected\" (click)=\"selectAllItems()\" [disabled]=\"!items.length\"></dfm-checkbox>\n        </dfm-table-header-cell>\n        <ng-content *ngTemplateOutlet=\"headerRowTemplate\"></ng-content>\n      </tr>\n    </thead>\n    <tbody>\n      <tr *ngFor=\"let item of items\" class=\"body-row\" (click)=\"click(item)\" [class.pointer]=\"rowClickable\">\n        <dfm-table-body-cell [propagateClick]=\"false\" *ngIf=\"selectable\" class=\"checkbox-cell\" [class.checkbox-first-frozen]=\"isHorizontalScrollDisplayed\">\n          <dfm-checkbox class=\"d-flex dfm-me-2\" [ngModel]=\"selectedItems[item.id]\" (ngModelChange)=\"selectItem($event, item.id)\"></dfm-checkbox>\n        </dfm-table-body-cell>\n        <ng-container *ngTemplateOutlet=\"bodyRowTemplate; context: { $implicit: item }\"></ng-container>\n      </tr>\n    </tbody>\n  </table>\n</div>\n", styles: [":host{height:100%}.dfm-table-wrapper{overflow:overlay;border:1px solid var(--dfm-table-border);border-radius:8px;white-space:nowrap;max-height:100%}.dfm-table{border-collapse:separate;border-spacing:0}.dfm-table .header{position:sticky;top:0;z-index:1}.dfm-table .body-row{border-top:1px solid var(--dfm-table-border)}.dfm-table .body-row:nth-child(even){background-color:var(--dfm-table-even-cell-bg)}.dfm-table .body-row:nth-child(odd){background-color:var(--dfm-table-odd-cell-bg)}\n"], dependencies: [{ kind: "directive", type: i1.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i1.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i1.NgTemplateOutlet, selector: "[ngTemplateOutlet]", inputs: ["ngTemplateOutletContext", "ngTemplateOutlet", "ngTemplateOutletInjector"] }, { kind: "directive", type: i2.ResizedDirective, selector: "[resized]", outputs: ["resized"] }, { kind: "component", type: i3.CheckboxComponent, selector: "dfm-checkbox", inputs: ["indeterminate"] }, { kind: "directive", type: i4.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i4.NgModel, selector: "[ngModel]:not([formControlName]):not([formControl])", inputs: ["name", "disabled", "ngModel", "ngModelOptions"], outputs: ["ngModelChange"], exportAs: ["ngModel"] }, { kind: "directive", type: i5.InfiniteScrollDirective, selector: "[infiniteScroll], [infinite-scroll], [data-infinite-scroll]", inputs: ["infiniteScrollDistance", "infiniteScrollUpDistance", "infiniteScrollThrottle", "infiniteScrollDisabled", "infiniteScrollContainer", "scrollWindow", "immediateCheck", "horizontal", "alwaysCallback", "fromRoot"], outputs: ["scrolled", "scrolledUp"] }, { kind: "component", type: i6.TableHeaderCellComponent, selector: "dfm-table-header-cell", inputs: ["sortable"], outputs: ["sort"] }, { kind: "component", type: i7.TableBodyCellComponent, selector: "dfm-table-body-cell", inputs: ["propagateClick", "contentAlign"] }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.12", ngImport: i0, type: TableComponent, decorators: [{
            type: Component,
            args: [{ selector: 'dfm-table', template: "<div class=\"dfm-table-wrapper\" #tableWrapper infiniteScroll (scrolled)=\"scrolled.emit()\" [scrollWindow]=\"false\">\n  <table\n    class=\"dfm-table w-100\"\n    [class.first-frozen]=\"isHorizontalScrollDisplayed\"\n    [class.compact-header]=\"compactHeader\"\n    (resized)=\"checkTableSize($event)\"\n  >\n    <thead class=\"header\">\n      <tr>\n        <dfm-table-header-cell *ngIf=\"selectable\" class=\"checkbox-cell\" [class.checkbox-first-frozen]=\"isHorizontalScrollDisplayed\">\n          <dfm-checkbox class=\"d-flex dfm-me-2\" [ngModel]=\"areAllSelected\" (click)=\"selectAllItems()\" [disabled]=\"!items.length\"></dfm-checkbox>\n        </dfm-table-header-cell>\n        <ng-content *ngTemplateOutlet=\"headerRowTemplate\"></ng-content>\n      </tr>\n    </thead>\n    <tbody>\n      <tr *ngFor=\"let item of items\" class=\"body-row\" (click)=\"click(item)\" [class.pointer]=\"rowClickable\">\n        <dfm-table-body-cell [propagateClick]=\"false\" *ngIf=\"selectable\" class=\"checkbox-cell\" [class.checkbox-first-frozen]=\"isHorizontalScrollDisplayed\">\n          <dfm-checkbox class=\"d-flex dfm-me-2\" [ngModel]=\"selectedItems[item.id]\" (ngModelChange)=\"selectItem($event, item.id)\"></dfm-checkbox>\n        </dfm-table-body-cell>\n        <ng-container *ngTemplateOutlet=\"bodyRowTemplate; context: { $implicit: item }\"></ng-container>\n      </tr>\n    </tbody>\n  </table>\n</div>\n", styles: [":host{height:100%}.dfm-table-wrapper{overflow:overlay;border:1px solid var(--dfm-table-border);border-radius:8px;white-space:nowrap;max-height:100%}.dfm-table{border-collapse:separate;border-spacing:0}.dfm-table .header{position:sticky;top:0;z-index:1}.dfm-table .body-row{border-top:1px solid var(--dfm-table-border)}.dfm-table .body-row:nth-child(even){background-color:var(--dfm-table-even-cell-bg)}.dfm-table .body-row:nth-child(odd){background-color:var(--dfm-table-odd-cell-bg)}\n"] }]
        }], propDecorators: { items: [{
                type: Input
            }], selectable: [{
                type: Input
            }], clearSelected$: [{
                type: Input
            }], rowClickable: [{
                type: Input
            }], compactHeader: [{
                type: Input
            }], selected: [{
                type: Output
            }], rowClicked: [{
                type: Output
            }], scrolled: [{
                type: Output
            }], headerRowTemplate: [{
                type: ContentChild,
                args: ['headerRowTemplate']
            }], bodyRowTemplate: [{
                type: ContentChild,
                args: ['bodyRowTemplate']
            }], tableWrapper: [{
                type: ViewChild,
                args: ['tableWrapper', { static: false }]
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFibGUuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvZGlmbGV4bW8tYW5ndWxhci1kZXNpZ24vc3JjL2xpYi9kZXNpZ24tc3lzdGVtL21vZHVsZXMvdGFibGUvY29tcG9uZW50cy90YWJsZS90YWJsZS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9kaWZsZXhtby1hbmd1bGFyLWRlc2lnbi9zcmMvbGliL2Rlc2lnbi1zeXN0ZW0vbW9kdWxlcy90YWJsZS9jb21wb25lbnRzL3RhYmxlL3RhYmxlLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFjLFlBQVksRUFBRSxLQUFLLEVBQVUsTUFBTSxFQUFlLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVqSSxPQUFPLEVBQUUsWUFBWSxFQUFFLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQzs7Ozs7Ozs7O0FBUTdDLE1BQU0sT0FBTyxjQUFjO0lBTDNCO1FBTVcsVUFBSyxHQUFnQixFQUFFLENBQUM7UUFFeEIsZUFBVSxHQUFZLEtBQUssQ0FBQztRQUk1QixpQkFBWSxHQUFZLEtBQUssQ0FBQztRQUU5QixrQkFBYSxHQUFZLEtBQUssQ0FBQztRQUU5QixhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQVksQ0FBQztRQUV4QyxlQUFVLEdBQUcsSUFBSSxZQUFZLEVBQWEsQ0FBQztRQUUzQyxhQUFRLEdBQUcsSUFBSSxZQUFZLEVBQUUsQ0FBQztRQVFqQyxzQkFBaUIsR0FBRyxJQUFJLE9BQU8sRUFBZ0IsQ0FBQztRQUVoRCxnQ0FBMkIsR0FBWSxLQUFLLENBQUM7UUFFN0Msa0JBQWEsR0FBK0IsRUFBRSxDQUFDO0tBdUR2RDtJQXJEQyxJQUFXLGNBQWM7UUFDdkIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQztJQUM5RyxDQUFDO0lBRUQsUUFBUTtRQUNOLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsS0FBbUIsRUFBRSxFQUFFO1lBQy9FLE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDO1lBQ3RFLE1BQU0sVUFBVSxHQUFHLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDO1lBQ3ZDLElBQUksQ0FBQywyQkFBMkIsR0FBRyxpQkFBaUIsR0FBRyxVQUFVLENBQUM7UUFDcEUsQ0FBQyxDQUFDLENBQUM7UUFFSCxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsQ0FBQztTQUMvRDtRQUVELElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUN2QixJQUFJLENBQUMsY0FBYyxDQUFDLFNBQVMsQ0FBQyxHQUFHLEVBQUU7Z0JBQ2pDLElBQUksQ0FBQyxhQUFhLEdBQUcsRUFBRSxDQUFDO2dCQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztTQUNKO0lBQ0gsQ0FBQztJQUVELGNBQWMsQ0FBQyxLQUFtQjtRQUNoQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxjQUFjO1FBQ1osSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUU7WUFDeEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRTtnQkFDL0IsSUFBSSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDO2dCQUNoQyxPQUFPLENBQUMsQ0FBQyxFQUFFLENBQUM7WUFDZCxDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1NBQ3pCO2FBQU07WUFDTCxJQUFJLENBQUMsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUN4QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztTQUN4QjtJQUNILENBQUM7SUFFRCxVQUFVLENBQUMsUUFBaUIsRUFBRSxFQUFVO1FBQ3RDLElBQUksQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDO1FBRWxDLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQzthQUMzQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQzthQUM1QixHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUV2QixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsS0FBSyxDQUFDLElBQWU7UUFDbkIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDN0IsQ0FBQzs7NEdBakZVLGNBQWM7Z0dBQWQsY0FBYyxpbUJDVjNCLDI0Q0F5QkE7NEZEZmEsY0FBYztrQkFMMUIsU0FBUzsrQkFDRSxXQUFXOzhCQUtaLEtBQUs7c0JBQWIsS0FBSztnQkFFRyxVQUFVO3NCQUFsQixLQUFLO2dCQUVHLGNBQWM7c0JBQXRCLEtBQUs7Z0JBRUcsWUFBWTtzQkFBcEIsS0FBSztnQkFFRyxhQUFhO3NCQUFyQixLQUFLO2dCQUVJLFFBQVE7c0JBQWpCLE1BQU07Z0JBRUcsVUFBVTtzQkFBbkIsTUFBTTtnQkFFRyxRQUFRO3NCQUFqQixNQUFNO2dCQUU0QixpQkFBaUI7c0JBQW5ELFlBQVk7dUJBQUMsbUJBQW1CO2dCQUVBLGVBQWU7c0JBQS9DLFlBQVk7dUJBQUMsaUJBQWlCO2dCQUVlLFlBQVk7c0JBQXpELFNBQVM7dUJBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENvbXBvbmVudCwgQ29udGVudENoaWxkLCBFbGVtZW50UmVmLCBFdmVudEVtaXR0ZXIsIElucHV0LCBPbkluaXQsIE91dHB1dCwgVGVtcGxhdGVSZWYsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUmVzaXplZEV2ZW50IH0gZnJvbSAnYW5ndWxhci1yZXNpemUtZXZlbnQnO1xuaW1wb3J0IHsgZGVib3VuY2VUaW1lLCBTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBUYWJsZUl0ZW0gfSBmcm9tICcuLi8uLi9tb2RlbHMvdGFibGUtaXRlbSc7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2RmbS10YWJsZScsXG4gIHRlbXBsYXRlVXJsOiAnLi90YWJsZS5jb21wb25lbnQuaHRtbCcsXG4gIHN0eWxlVXJsczogWycuL3RhYmxlLmNvbXBvbmVudC5zY3NzJ10sXG59KVxuZXhwb3J0IGNsYXNzIFRhYmxlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0IHtcbiAgQElucHV0KCkgaXRlbXM6IFRhYmxlSXRlbVtdID0gW107XG5cbiAgQElucHV0KCkgc2VsZWN0YWJsZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIEBJbnB1dCgpIGNsZWFyU2VsZWN0ZWQkPzogU3ViamVjdDx2b2lkPiB8IG51bGw7XG5cbiAgQElucHV0KCkgcm93Q2xpY2thYmxlOiBib29sZWFuID0gZmFsc2U7XG5cbiAgQElucHV0KCkgY29tcGFjdEhlYWRlcjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIEBPdXRwdXQoKSBzZWxlY3RlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nW10+KCk7XG5cbiAgQE91dHB1dCgpIHJvd0NsaWNrZWQgPSBuZXcgRXZlbnRFbWl0dGVyPFRhYmxlSXRlbT4oKTtcblxuICBAT3V0cHV0KCkgc2Nyb2xsZWQgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG5cbiAgQENvbnRlbnRDaGlsZCgnaGVhZGVyUm93VGVtcGxhdGUnKSBoZWFkZXJSb3dUZW1wbGF0ZSE6IFRlbXBsYXRlUmVmPGFueT47XG5cbiAgQENvbnRlbnRDaGlsZCgnYm9keVJvd1RlbXBsYXRlJykgYm9keVJvd1RlbXBsYXRlITogVGVtcGxhdGVSZWY8YW55PjtcblxuICBAVmlld0NoaWxkKCd0YWJsZVdyYXBwZXInLCB7IHN0YXRpYzogZmFsc2UgfSkgdGFibGVXcmFwcGVyITogRWxlbWVudFJlZjtcblxuICBwdWJsaWMgdGFibGVTaXplQ2hhbmdlZCQgPSBuZXcgU3ViamVjdDxSZXNpemVkRXZlbnQ+KCk7XG5cbiAgcHVibGljIGlzSG9yaXpvbnRhbFNjcm9sbERpc3BsYXllZDogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHB1YmxpYyBzZWxlY3RlZEl0ZW1zOiB7IFtrZXk6IHN0cmluZ106IGJvb2xlYW4gfSA9IHt9O1xuXG4gIHB1YmxpYyBnZXQgYXJlQWxsU2VsZWN0ZWQoKSB7XG4gICAgcmV0dXJuIHRoaXMuaXRlbXMubGVuZ3RoICYmIE9iamVjdC52YWx1ZXModGhpcy5zZWxlY3RlZEl0ZW1zKS5maWx0ZXIoKHYpID0+IHYpLmxlbmd0aCA9PT0gdGhpcy5pdGVtcy5sZW5ndGg7XG4gIH1cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnRhYmxlU2l6ZUNoYW5nZWQkLnBpcGUoZGVib3VuY2VUaW1lKDEwMCkpLnN1YnNjcmliZSgoZXZlbnQ6IFJlc2l6ZWRFdmVudCkgPT4ge1xuICAgICAgY29uc3QgdGFibGVXcmFwcGVyV2lkdGggPSB0aGlzLnRhYmxlV3JhcHBlci5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICAgICAgY29uc3QgdGFibGVXaWR0aCA9IGV2ZW50Lm5ld1JlY3Qud2lkdGg7XG4gICAgICB0aGlzLmlzSG9yaXpvbnRhbFNjcm9sbERpc3BsYXllZCA9IHRhYmxlV3JhcHBlcldpZHRoIDwgdGFibGVXaWR0aDtcbiAgICB9KTtcblxuICAgIGlmICh0aGlzLnNlbGVjdGFibGUpIHtcbiAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaCgoaSkgPT4gKHRoaXMuc2VsZWN0ZWRJdGVtc1tpLmlkXSA9IGZhbHNlKSk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuY2xlYXJTZWxlY3RlZCQpIHtcbiAgICAgIHRoaXMuY2xlYXJTZWxlY3RlZCQuc3Vic2NyaWJlKCgpID0+IHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW1zID0ge307XG4gICAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdChbXSk7XG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICBjaGVja1RhYmxlU2l6ZShldmVudDogUmVzaXplZEV2ZW50KSB7XG4gICAgdGhpcy50YWJsZVNpemVDaGFuZ2VkJC5uZXh0KGV2ZW50KTtcbiAgfVxuXG4gIHNlbGVjdEFsbEl0ZW1zKCkge1xuICAgIGlmICghdGhpcy5hcmVBbGxTZWxlY3RlZCkge1xuICAgICAgY29uc3QgaWRzID0gdGhpcy5pdGVtcy5tYXAoKGkpID0+IHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZEl0ZW1zW2kuaWRdID0gdHJ1ZTtcbiAgICAgICAgcmV0dXJuIGkuaWQ7XG4gICAgICB9KTtcbiAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdChpZHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnNlbGVjdGVkSXRlbXMgPSB7fTtcbiAgICAgIHRoaXMuc2VsZWN0ZWQuZW1pdChbXSk7XG4gICAgfVxuICB9XG5cbiAgc2VsZWN0SXRlbShzZWxlY3RlZDogYm9vbGVhbiwgaWQ6IHN0cmluZykge1xuICAgIHRoaXMuc2VsZWN0ZWRJdGVtc1tpZF0gPSBzZWxlY3RlZDtcblxuICAgIGNvbnN0IGlkcyA9IE9iamVjdC5lbnRyaWVzKHRoaXMuc2VsZWN0ZWRJdGVtcylcbiAgICAgIC5maWx0ZXIoKFssIHZhbHVlXSkgPT4gdmFsdWUpXG4gICAgICAubWFwKChba2V5XSkgPT4ga2V5KTtcblxuICAgIHRoaXMuc2VsZWN0ZWQuZW1pdChpZHMpO1xuICB9XG5cbiAgY2xpY2soaXRlbTogVGFibGVJdGVtKSB7XG4gICAgdGhpcy5yb3dDbGlja2VkLmVtaXQoaXRlbSk7XG4gIH1cbn1cbiIsIjxkaXYgY2xhc3M9XCJkZm0tdGFibGUtd3JhcHBlclwiICN0YWJsZVdyYXBwZXIgaW5maW5pdGVTY3JvbGwgKHNjcm9sbGVkKT1cInNjcm9sbGVkLmVtaXQoKVwiIFtzY3JvbGxXaW5kb3ddPVwiZmFsc2VcIj5cbiAgPHRhYmxlXG4gICAgY2xhc3M9XCJkZm0tdGFibGUgdy0xMDBcIlxuICAgIFtjbGFzcy5maXJzdC1mcm96ZW5dPVwiaXNIb3Jpem9udGFsU2Nyb2xsRGlzcGxheWVkXCJcbiAgICBbY2xhc3MuY29tcGFjdC1oZWFkZXJdPVwiY29tcGFjdEhlYWRlclwiXG4gICAgKHJlc2l6ZWQpPVwiY2hlY2tUYWJsZVNpemUoJGV2ZW50KVwiXG4gID5cbiAgICA8dGhlYWQgY2xhc3M9XCJoZWFkZXJcIj5cbiAgICAgIDx0cj5cbiAgICAgICAgPGRmbS10YWJsZS1oZWFkZXItY2VsbCAqbmdJZj1cInNlbGVjdGFibGVcIiBjbGFzcz1cImNoZWNrYm94LWNlbGxcIiBbY2xhc3MuY2hlY2tib3gtZmlyc3QtZnJvemVuXT1cImlzSG9yaXpvbnRhbFNjcm9sbERpc3BsYXllZFwiPlxuICAgICAgICAgIDxkZm0tY2hlY2tib3ggY2xhc3M9XCJkLWZsZXggZGZtLW1lLTJcIiBbbmdNb2RlbF09XCJhcmVBbGxTZWxlY3RlZFwiIChjbGljayk9XCJzZWxlY3RBbGxJdGVtcygpXCIgW2Rpc2FibGVkXT1cIiFpdGVtcy5sZW5ndGhcIj48L2RmbS1jaGVja2JveD5cbiAgICAgICAgPC9kZm0tdGFibGUtaGVhZGVyLWNlbGw+XG4gICAgICAgIDxuZy1jb250ZW50ICpuZ1RlbXBsYXRlT3V0bGV0PVwiaGVhZGVyUm93VGVtcGxhdGVcIj48L25nLWNvbnRlbnQ+XG4gICAgICA8L3RyPlxuICAgIDwvdGhlYWQ+XG4gICAgPHRib2R5PlxuICAgICAgPHRyICpuZ0Zvcj1cImxldCBpdGVtIG9mIGl0ZW1zXCIgY2xhc3M9XCJib2R5LXJvd1wiIChjbGljayk9XCJjbGljayhpdGVtKVwiIFtjbGFzcy5wb2ludGVyXT1cInJvd0NsaWNrYWJsZVwiPlxuICAgICAgICA8ZGZtLXRhYmxlLWJvZHktY2VsbCBbcHJvcGFnYXRlQ2xpY2tdPVwiZmFsc2VcIiAqbmdJZj1cInNlbGVjdGFibGVcIiBjbGFzcz1cImNoZWNrYm94LWNlbGxcIiBbY2xhc3MuY2hlY2tib3gtZmlyc3QtZnJvemVuXT1cImlzSG9yaXpvbnRhbFNjcm9sbERpc3BsYXllZFwiPlxuICAgICAgICAgIDxkZm0tY2hlY2tib3ggY2xhc3M9XCJkLWZsZXggZGZtLW1lLTJcIiBbbmdNb2RlbF09XCJzZWxlY3RlZEl0ZW1zW2l0ZW0uaWRdXCIgKG5nTW9kZWxDaGFuZ2UpPVwic2VsZWN0SXRlbSgkZXZlbnQsIGl0ZW0uaWQpXCI+PC9kZm0tY2hlY2tib3g+XG4gICAgICAgIDwvZGZtLXRhYmxlLWJvZHktY2VsbD5cbiAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdUZW1wbGF0ZU91dGxldD1cImJvZHlSb3dUZW1wbGF0ZTsgY29udGV4dDogeyAkaW1wbGljaXQ6IGl0ZW0gfVwiPjwvbmctY29udGFpbmVyPlxuICAgICAgPC90cj5cbiAgICA8L3Rib2R5PlxuICA8L3RhYmxlPlxuPC9kaXY+XG4iXX0=