<div class="d-flex flex-column dfm-gap-24 ad-ap-main-wrapper">
  <section class="content-section-1">
    <div class="d-flex dfm-gap-8 align-items-center dfm-text-primary ad-ap-title-buttons">
      <dfm-button color="link" size="lg"
                  [routerLink]="[comingFromRoute === 'dashboard' ? '/dashboard' : '/appointment']">
        {{ comingFromRoute === 'dashboard' ? 'Dashboard' : 'Appointment' }}
      </dfm-button>

      <div style="width: 16px; height: 16px" class="h-fit">
        <dfm-icon name="chevron-right"></dfm-icon>
      </div>

      <dfm-button
        color="link"
        size="lg"
        *ngIf="comingFromRoute === 'dashboard'"
        [routerLink]="[comingFromRoute === 'dashboard' ? '/dashboard' : '/appointment']"
      >
        {{ comingFromRoute === 'dashboard' ? 'Appointment' : '' }}
      </dfm-button>

      <div style="width: 16px; height: 16px" class="h-fit" *ngIf="comingFromRoute === 'dashboard'">
        <dfm-icon name="chevron-right"></dfm-icon>
      </div>

      <div class="d-flex align-items-center dfm-gap-8" *ngIf="comingFromRoute === 'view' && appointment$$.value?.id">
        <dfm-button color="link" size="lg" [routerLink]="['../', 'view']">View</dfm-button>

        <div style="width: 16px; height: 16px" class="h-fit">
          <dfm-icon name="chevron-right"></dfm-icon>
        </div>
      </div>

      <dfm-button color="link-gray" size="lg">{{ edit ? 'Edit' : 'Add' }} </dfm-button>
    </div>

    <div class="dfm-gap-16 ad-ap-action-buttons">
      <dfm-button color="secondary" size="md" [routerLink]="[comingFromRoute === 'view' ? '../view' : '/appointment']">
        Cancel
      </dfm-button>
      <dfm-button [disabled]="(submitting$$ | async) === true" color="primary" size="md" class="text-nowrap" (click)="saveAppointment()"
      >{{ edit ? 'Save Changes' : 'Add Appointment' }}
      </dfm-button>
    </div>

    <!--  Mobile View  -->
    <div class="hidden dfm-gap-8 align-items-center ad-ap-title-buttons-mv">
      <div class="rounded-circle overflow-hidden">
        <dfm-button-icon color="tertiary-gray" size="sm" icon="chevron-left"
                         [routerLink]="comingFromRoute === 'view' ? '../view' : '/appointment'">
        </dfm-button-icon>
      </div>

      <dfm-button color="link" size="lg" routerLink="./"> {{ edit ? 'Edit' : 'Add' }} Appointment</dfm-button>
    </div>
    <!--  **  -->
  </section>

  <section class="dfm-card dfm-p-16 ad-ap-section2 add-page-content-height">
    <form [formGroup]="appointmentForm" *ngIf="appointment$$ | async" class="d-flex flex-column dfm-gap-24 dfm-mb-16">
      <div class="d-flex dfm-gap-32 align-items-start">
        <dfm-input class="flex-1" size="md" placeholder="Enter first name" label="Patient First Name *"
                   formControlName="patientFname" #pFName [dfmNameInput]="pFName"></dfm-input>

        <dfm-input class="flex-1" size="md" placeholder="Enter last name" label="Patient Last Name *"
                   formControlName="patientLname" #pLName [dfmNameInput]="pLName"></dfm-input>

        <dfm-input class="flex-1" size="md" placeholder="Enter Telephone" label="Enter Telephone *"
                   formControlName="patientTel" #phone [dfmNumberInput]="phone">
        </dfm-input>
      </div>

      <div class="d-flex dfm-gap-32 align-items-start flex-wrap">
        <div class="d-flex flex-column flex-1 w-full">
          <dfm-input class="flex-1 min-w-128" size="md" placeholder="Enter Patient Email" label="Patient Email *"
                     formControlName="patientEmail" (focusout)="handleEmailInput($event)">
          </dfm-input>
          <small *ngIf="appointmentForm.get('patientEmail')?.hasError('email')" class="validation-error">Email is Invalid.</small>
        </div>

        <div class="dfm-input-dropdown-wrapper flex-1 w-full min-w-128" *ngIf="physicianList.length">
          <dfm-input-dropdown [items]="physicianList" class="flex-1" size="md" placeholder="Select doctor"
                              label="Doctor *" formControlName="doctorId">
          </dfm-input-dropdown>
        </div>

        <div class="dfm-input-dropdown-wrapper flex-1 w-full">
          <dfm-input-dropdown
            #generalUser
            [items]="userList"
            placeholder="Select General User"
            formControlName="userId"
            size="md"
            label="General User *"
          >
          </dfm-input-dropdown>
        </div>
      </div>

      <div class="exam-date d-flex flex-row">
        <div class="ad-ab-from-date flex-wrap-reverse dfm-gap-32 d-flex flex-1">
          <div class="dfm-input-multi-dropdown-wrapper min-w-256 ad-ap-multi-dropdown flex-1">
            <dfm-input-dropdown
              #exams
              [items]="examList"
              [multiple]="true"
              [placeholder]="!!exams.value?.length ? exams.value.length + ' Selected' : 'Select Exams'"
              formControlName="examList"
              size="md"
              label="Exams *"
            >
            </dfm-input-dropdown>
          </div>

          <div class="flex-1">
            <div class="d-flex flex-column dfm-gap-8 flex-wrap">
              <span class="text-sm font-weight-medium dfm-text-main-700">Date *</span>
              <div class="d-flex align-items-center dfm-gap-16 ad-ap-dates">
                <div class="dfm-button-group-wrapper w-full h-fit">
                  <div class="input-as-dfm-input">
                    <input class="w-full min-w-128" formControlName="startedAt" placeholder="yyyy-mm-dd" required ngbDatepicker
                           #date="ngbDatepicker"/>
                  </div>
                  <div>
                    <dfm-button-icon color="tertiary-gray" size="md" icon="calendar-date"
                                     (click)="date.toggle()"></dfm-button-icon>
                  </div>
                </div>
              </div>
            </div>
            <span
              *ngIf="appointmentForm.get('startedAt')?.hasError('required') && appointmentForm.get('startedAt')?.touched"
              class="validation-error">This field is required.</span>
          </div>

          <div class="flex-1 temp-element"></div>
        </div>
      </div>

      <span class="font-weight-medium text-sm dfm-my-8"
            *ngIf="exams?.value?.length && formValues.startedAt?.day && !slots?.length && (loadingSlots$$ | async) === false">
        No slots found for selected Exams and Date combination.
      </span>

      <span class="font-weight-medium dfm-text-main-500 text-sm dfm-my-8" *ngIf="loadingSlots$$ | async">
        Loading slots...
      </span>


      <div class="ad-ap-slots-container dfm-gap-16 w-full overflow-x-auto" *ngIf="slots?.length">
        <div class="dfm-card d-flex flex-column dfm-p-16 card-item" *ngFor="let exam of exams.value">
          <div class="d-flex flex-column gap-1">
            <div class="d-flex gap-2 align-items-center text-sm">
              <span class="font-weight-medium">Exam Name: </span>
              <span>{{ examIdToDetails[exam]?.name }}</span>
            </div>
          </div>

          <div class="d-flex align-items-center gap-3 overflow-y-auto max-h-128 dfm-mt-12 flex-wrap">
            <div
              class="time-slot-text dfm-p-8 text-center text-sm font-weight-medium w-128"
              *ngFor="let slot of examIdToAppointmentSlots[exam];"
              (click)="toggleSlotSelection(slot)"
              [ngClass]="{
                            'time-slot-disabled-text': !isSlotAvailable(slot),
                            'time-slot-selected-text': selectedTimeSlot[exam] === (slot.start + '-' + slot.end)
                          }"
            >
              {{ slot.start?.slice(0, -3) }} - {{ slot.end?.slice(0, -3) }}
            </div>
          </div>
        </div>
      </div>

      <dfm-text-area label="Comments / Clinical data" placeholder="Enter comments"
                     formControlName="comments"></dfm-text-area>
    </form>
  </section>
</div>
